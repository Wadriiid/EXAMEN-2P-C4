-- ============================================
-- SymmetricDS Configuration SQL - América
-- Configuración de Replicación Bidireccional
-- PostgreSQL ↔ MySQL
-- ============================================

-- ============================================
-- FASE 1: GRUPOS DE NODOS
-- ============================================
-- Grupo para el nodo de América (PostgreSQL)
insert into sym_node_group (node_group_id, description) 
values ('america-store', 'America Store - PostgreSQL 15');

-- Grupo para el nodo de Europa (MySQL)
insert into sym_node_group (node_group_id, description) 
values ('europe-store', 'Europe Store - MySQL 8.0');

-- ============================================
-- FASE 2: ENLACES BIDIRECCIONALES
-- ============================================
-- América envía datos a Europa (W = Wait for acknowledgment)
insert into sym_node_group_link 
  (source_node_group_id, target_node_group_id, data_event_action) 
values ('america-store', 'europe-store', 'W');

-- Europa envía datos a América (bidireccional)
insert into sym_node_group_link 
  (source_node_group_id, target_node_group_id, data_event_action) 
values ('europe-store', 'america-store', 'W');

-- ============================================
-- FASE 3: CANALES DE DATOS
-- ============================================
-- Canal para productos (catálogo)
insert into sym_channel 
  (channel_id, processing_order, max_batch_size, enabled, description)
values ('products_channel', 10, 10000, 1, 'Products catalog data channel');

-- Canal para inventario (stock)
insert into sym_channel 
  (channel_id, processing_order, max_batch_size, enabled, description)
values ('inventory_channel', 20, 10000, 1, 'Inventory and stock data channel');

-- Canal para clientes
insert into sym_channel 
  (channel_id, processing_order, max_batch_size, enabled, description)
values ('customers_channel', 30, 10000, 1, 'Customer relationship data channel');

-- Canal para promociones
insert into sym_channel 
  (channel_id, processing_order, max_batch_size, enabled, description)
values ('promotions_channel', 40, 10000, 1, 'Promotions and discounts channel');

-- ============================================
-- FASE 4: TRIGGERS (Captura de cambios)
-- ============================================
-- Trigger para tabla products
insert into sym_trigger 
  (trigger_id, source_table_name, channel_id, 
   last_update_time, create_time)
values ('products_trigger', 'products', 'products_channel', 
   current_timestamp, current_timestamp);

-- Trigger para tabla inventory
insert into sym_trigger 
  (trigger_id, source_table_name, channel_id, 
   last_update_time, create_time)
values ('inventory_trigger', 'inventory', 'inventory_channel', 
   current_timestamp, current_timestamp);

-- Trigger para tabla customers
insert into sym_trigger 
  (trigger_id, source_table_name, channel_id, 
   last_update_time, create_time)
values ('customers_trigger', 'customers', 'customers_channel', 
   current_timestamp, current_timestamp);

-- Trigger para tabla promotions
insert into sym_trigger 
  (trigger_id, source_table_name, channel_id, 
   last_update_time, create_time)
values ('promotions_trigger', 'promotions', 'promotions_channel', 
   current_timestamp, current_timestamp);

-- ============================================
-- FASE 5: ROUTERS (Enrutamiento)
-- ============================================
-- Router de América a Europa
insert into sym_router 
  (router_id, source_node_group_id, target_node_group_id, 
   router_type, create_time, last_update_time)
values ('america_to_europe', 'america-store', 'europe-store', 
   'default', current_timestamp, current_timestamp);

-- Router de Europa a América
insert into sym_router 
  (router_id, source_node_group_id, target_node_group_id, 
   router_type, create_time, last_update_time)
values ('europe_to_america', 'europe-store', 'america-store', 
   'default', current_timestamp, current_timestamp);

-- ============================================
-- FASE 6: VINCULACIÓN TRIGGER-ROUTER
-- ============================================
-- Productos: América → Europa
insert into sym_trigger_router 
  (trigger_id, router_id, initial_load_order, 
   last_update_time, create_time)
values ('products_trigger', 'america_to_europe', 100, 
   current_timestamp, current_timestamp);

-- Productos: Europa → América
insert into sym_trigger_router 
  (trigger_id, router_id, initial_load_order, 
   last_update_time, create_time)
values ('products_trigger', 'europe_to_america', 100, 
   current_timestamp, current_timestamp);

-- Inventario: América → Europa
insert into sym_trigger_router 
  (trigger_id, router_id, initial_load_order, 
   last_update_time, create_time)
values ('inventory_trigger', 'america_to_europe', 200, 
   current_timestamp, current_timestamp);

-- Inventario: Europa → América
insert into sym_trigger_router 
  (trigger_id, router_id, initial_load_order, 
   last_update_time, create_time)
values ('inventory_trigger', 'europe_to_america', 200, 
   current_timestamp, current_timestamp);

-- Clientes: América → Europa
insert into sym_trigger_router 
  (trigger_id, router_id, initial_load_order, 
   last_update_time, create_time)
values ('customers_trigger', 'america_to_europe', 300, 
   current_timestamp, current_timestamp);

-- Clientes: Europa → América
insert into sym_trigger_router 
  (trigger_id, router_id, initial_load_order, 
   last_update_time, create_time)
values ('customers_trigger', 'europe_to_america', 300, 
   current_timestamp, current_timestamp);

-- Promociones: América → Europa
insert into sym_trigger_router 
  (trigger_id, router_id, initial_load_order, 
   last_update_time, create_time)
values ('promotions_trigger', 'america_to_europe', 400, 
   current_timestamp, current_timestamp);

-- Promociones: Europa → América
insert into sym_trigger_router 
  (trigger_id, router_id, initial_load_order, 
   last_update_time, create_time)
values ('promotions_trigger', 'europe_to_america', 400, 
   current_timestamp, current_timestamp);

